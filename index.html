<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="Gestion de location de photobooths">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📷</text></svg>">
  <title>Calendri-Booth</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- NOUVELLE API Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ⚠️ REMPLACEZ ICI VOS CLÉS GOOGLE
    const CLIENT_ID = '362970811261-so4j6u31rbtajuipar964bs9818a56sa.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyC9RPC7clQA_v3gFvCDUaw21OHlZ2yOr3c';
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file';

    function PhotoboothManager() {
      const [view, setView] = useState('calendar');
      const [currentDate, setCurrentDate] = useState(new Date());
      const [bornes, setBornes] = useState([]);
      const [forfaits, setForfaits] = useState([]);
      const [reservations, setReservations] = useState([]);
      const [rdvs, setRdvs] = useState([]);
      const [bobines, setBobines] = useState([]);
      const [stock, setStock] = useState([]);
      const [showAddModal, setShowAddModal] = useState(false);
      const [modalType, setModalType] = useState('');
      const [formData, setFormData] = useState({});
      const [editingItem, setEditingItem] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [showDateMenu, setShowDateMenu] = useState(null);
      const [showEventDetail, setShowEventDetail] = useState(null);
      const [showDayEvents, setShowDayEvents] = useState(null);
      const [notifications, setNotifications] = useState([]);
      const [showNotifications, setShowNotifications] = useState(false);
      const [notificationSettings, setNotificationSettings] = useState({
        telegram: { enabled: false, botToken: '', chatId: '' },
        weeklyReminder: true,
        dailyReminder: true,
        urgentAlerts: true,
        stockAlerts: true,
        autoBackupInterval: 60 // minutes
      });
      const [isGapiLoaded, setIsGapiLoaded] = useState(false);
      const [accessToken, setAccessToken] = useState(null);
      const [lastBackup, setLastBackup] = useState(null);
      const [backupStatus, setBackupStatus] = useState('idle');
      const [nextAutoBackup, setNextAutoBackup] = useState(null);
      
      const tokenClient = useRef(null);
      const autoBackupTimerRef = useRef(null);
      const countdownTimerRef = useRef(null);

      // Initialisation de Google API
      useEffect(() => {
        const initializeGapi = () => {
          gapi.load('client', async () => {
            try {
              await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
              });
              setIsGapiLoaded(true);
              console.log('✅ Google API Client initialisé');
            } catch (err) {
              console.error('❌ Erreur init gapi.client:', err);
            }
          });
        };

        // Initialiser le client OAuth2
        const initializeGSI = () => {
          if (typeof google !== 'undefined' && google.accounts) {
            tokenClient.current = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (response) => {
                if (response.access_token) {
                  setAccessToken(response.access_token);
                  localStorage.setItem('accessToken', response.access_token);
                  gapi.client.setToken({ access_token: response.access_token });
                  console.log('✅ Authentifié avec succès');
                  addNotification('info', '✅ Connecté', 'Connecté à Google Drive', 'normal');
                  loadFromDrive();
                } else {
                  console.error('❌ Pas de token reçu');
                }
              },
            });
            console.log('✅ Google Identity Services initialisé');
            
            // Restaurer le token si disponible
            const savedToken = localStorage.getItem('accessToken');
            if (savedToken) {
              setAccessToken(savedToken);
              gapi.client.setToken({ access_token: savedToken });
              loadFromDrive();
            }
          }
        };

        if (document.readyState === 'complete') {
          initializeGapi();
          initializeGSI();
        } else {
          window.addEventListener('load', () => {
            initializeGapi();
            initializeGSI();
          });
        }
      }, []);

      // Fonction de connexion
      const handleGoogleSignIn = () => {
        if (tokenClient.current) {
          tokenClient.current.requestAccessToken({ prompt: 'consent' });
        }
      };

      // Fonction de déconnexion
      const handleGoogleSignOut = () => {
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken, () => {
            setAccessToken(null);
            localStorage.removeItem('accessToken');
            gapi.client.setToken(null);
            if (autoBackupTimerRef.current) {
              clearInterval(autoBackupTimerRef.current);
            }
            if (countdownTimerRef.current) {
              clearInterval(countdownTimerRef.current);
            }
            addNotification('info', '👋 Déconnecté', 'Déconnecté de Google Drive', 'normal');
          });
        }
      };

      // Sauvegarde sur Drive
      const saveToDrive = async (isAuto = false) => {
        if (!accessToken) {
          if (!isAuto) {
            alert('❌ Connectez-vous à Google Drive pour sauvegarder');
          }
          return;
        }

        setBackupStatus('saving');
        
        const data = {
          bornes,
          forfaits,
          reservations,
          rdvs,
          bobines,
          stock,
          notifications,
          notificationSettings,
          lastBackup: new Date().toISOString()
        };

        try {
          const response = await gapi.client.drive.files.list({
            spaces: 'appDataFolder',
            fields: 'files(id, name)',
            q: "name='calendri_booth_backup.json'"
          });

          const boundary = '-------314159265358979323846';
          const delimiter = "\r\n--" + boundary + "\r\n";
          const close_delim = "\r\n--" + boundary + "--";

          const metadata = {
            name: 'calendri_booth_backup.json',
            mimeType: 'application/json',
            parents: ['appDataFolder']
          };

          const multipartRequestBody =
            delimiter +
            'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(data) +
            close_delim;

          let fileId = null;
          if (response.result.files && response.result.files.length > 0) {
            fileId = response.result.files[0].id;
          }

          const requestUrl = fileId 
            ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`
            : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

          const requestMethod = fileId ? 'PATCH' : 'POST';

          const fetchResponse = await fetch(requestUrl, {
            method: requestMethod,
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': `multipart/related; boundary="${boundary}"`
            },
            body: multipartRequestBody
          });

          if (fetchResponse.ok) {
            const newBackupTime = new Date().toISOString();
            setLastBackup(newBackupTime);
            localStorage.setItem('lastBackup', newBackupTime);
            setBackupStatus('success');
            addNotification('info', isAuto ? '🤖 Sauvegarde auto' : '💾 Sauvegarde', 'Données sauvegardées sur Google Drive', 'normal');
            setTimeout(() => setBackupStatus('idle'), 3000);
          } else {
            throw new Error('Échec de la sauvegarde');
          }
        } catch (error) {
          console.error('❌ Erreur sauvegarde Drive:', error);
          setBackupStatus('error');
          if (!isAuto) {
            addNotification('warning', '⚠️ Erreur', 'Impossible de sauvegarder sur Drive', 'high');
          }
          setTimeout(() => setBackupStatus('idle'), 3000);
        }
      };

      // Chargement depuis Drive
      const loadFromDrive = async () => {
        if (!accessToken) return;

        try {
          const response = await gapi.client.drive.files.list({
            spaces: 'appDataFolder',
            fields: 'files(id, name)',
            q: "name='calendri_booth_backup.json'"
          });

          if (response.result.files && response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            
            const fileResponse = await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
              {
                headers: {
                  'Authorization': `Bearer ${accessToken}`
                }
              }
            );

            if (fileResponse.ok) {
              const data = await fileResponse.json();
              setBornes(data.bornes || []);
              setForfaits(data.forfaits || []);
              setReservations(data.reservations || []);
              setRdvs(data.rdvs || []);
              setBobines(data.bobines || []);
              setStock(data.stock || []);
              setNotifications(data.notifications || []);
              if (data.notificationSettings) {
                setNotificationSettings({
                  ...notificationSettings,
                  ...data.notificationSettings
                });
              }
              setLastBackup(data.lastBackup);
              localStorage.setItem('lastBackup', data.lastBackup);
              
              addNotification('info', '✅ Données restaurées', 'Chargées depuis Google Drive', 'normal');
            }
          } else {
            console.log('ℹ️ Aucun fichier de sauvegarde sur Drive');
            loadFromLocalStorage();
          }
        } catch (error) {
          console.error('❌ Erreur chargement Drive:', error);
          loadFromLocalStorage();
        }
      };

      // Sauvegarde automatique avec compteur
      useEffect(() => {
        if (!accessToken || !notificationSettings.autoBackupInterval) return;

        const intervalMinutes = notificationSettings.autoBackupInterval;
        const intervalMs = intervalMinutes * 60 * 1000;

        // Sauvegarder immédiatement si dernière sauvegarde > intervalle
        const savedLastBackup = localStorage.getItem('lastBackup');
        if (savedLastBackup) {
          const lastBackupTime = new Date(savedLastBackup);
          const now = new Date();
          const timeSinceLastBackup = now - lastBackupTime;
          if (timeSinceLastBackup > intervalMs) {
            saveToDrive(true);
          }
        }

        // Définir le prochain backup
        const nextBackupTime = new Date(Date.now() + intervalMs);
        setNextAutoBackup(nextBackupTime);

        // Timer pour la sauvegarde automatique
        autoBackupTimerRef.current = setInterval(() => {
          saveToDrive(true);
          const nextTime = new Date(Date.now() + intervalMs);
          setNextAutoBackup(nextTime);
        }, intervalMs);

        // Countdown timer pour afficher le temps restant
        countdownTimerRef.current = setInterval(() => {
          setNextAutoBackup(prev => {
            if (!prev) return null;
            return new Date(prev);
          });
        }, 60000); // Mise à jour toutes les minutes

        return () => {
          if (autoBackupTimerRef.current) clearInterval(autoBackupTimerRef.current);
          if (countdownTimerRef.current) clearInterval(countdownTimerRef.current);
        };
      }, [accessToken, notificationSettings.autoBackupInterval, bornes, forfaits, reservations, rdvs, bobines, stock]);

      // Calculer le temps restant avant la prochaine sauvegarde
      const getTimeUntilNextBackup = () => {
        if (!nextAutoBackup) return '';
        const now = new Date();
        const diff = nextAutoBackup - now;
        if (diff <= 0) return 'En cours...';
        
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        
        if (hours > 0) {
          return `${hours}h${mins}m`;
        }
        return `${mins}m`;
      };

      // Export manuel
      const exportData = () => {
        const data = {
          bornes,
          forfaits,
          reservations,
          rdvs,
          bobines,
          stock,
          notifications,
          notificationSettings,
          exportDate: new Date().toISOString()
        };

        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `calendri-booth-backup-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        
        addNotification('info', '💾 Export réussi', 'Fichier téléchargé', 'normal');
      };

      // Import manuel
      const importData = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            setBornes(data.bornes || []);
            setForfaits(data.forfaits || []);
            setReservations(data.reservations || []);
            setRdvs(data.rdvs || []);
            setBobines(data.bobines || []);
            setStock(data.stock || []);
            setNotifications(data.notifications || []);
            if (data.notificationSettings) {
              setNotificationSettings({
                ...notificationSettings,
                ...data.notificationSettings
              });
            }
            
            addNotification('info', '✅ Import réussi', 'Données restaurées', 'normal');
          } catch (error) {
            console.error('❌ Erreur import:', error);
            addNotification('warning', '⚠️ Erreur', 'Fichier invalide', 'high');
          }
        };
        reader.readAsText(file);
      };

      // Chargement localStorage
      const loadFromLocalStorage = () => {
        const items = ['bornes', 'forfaits', 'reservations', 'rdvs', 'bobines', 'stock', 'notifications', 'notificationSettings'];
        items.forEach(item => {
          const saved = localStorage.getItem(item);
          if (saved) {
            const parsed = JSON.parse(saved);
            switch(item) {
              case 'bornes': setBornes(parsed); break;
              case 'forfaits': setForfaits(parsed); break;
              case 'reservations': setReservations(parsed); break;
              case 'rdvs': setRdvs(parsed); break;
              case 'bobines': setBobines(parsed); break;
              case 'stock': setStock(parsed); break;
              case 'notifications': setNotifications(parsed); break;
              case 'notificationSettings': setNotificationSettings({...notificationSettings, ...parsed}); break;
            }
          }
        });
        
        const savedLastBackup = localStorage.getItem('lastBackup');
        if (savedLastBackup) setLastBackup(savedLastBackup);
      };

      // Chargement initial
      useEffect(() => {
        if (!accessToken) {
          loadFromLocalStorage();
        }
      }, []);

      // Sauvegarde locale automatique
      useEffect(() => {
        localStorage.setItem('bornes', JSON.stringify(bornes));
        localStorage.setItem('forfaits', JSON.stringify(forfaits));
        localStorage.setItem('reservations', JSON.stringify(reservations));
        localStorage.setItem('rdvs', JSON.stringify(rdvs));
        localStorage.setItem('bobines', JSON.stringify(bobines));
        localStorage.setItem('stock', JSON.stringify(stock));
        localStorage.setItem('notifications', JSON.stringify(notifications));
        localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
      }, [bornes, forfaits, reservations, rdvs, bobines, stock, notifications, notificationSettings]);

      const findAvailableBobine = (photosNeeded) => {
        const bobinesWithReservations = bobines.map(bobine => {
          const reserved = reservations
            .filter(r => r.bobineId === bobine.id && !r.bobineConsommee)
            .reduce((sum, r) => {
              const forfait = forfaits.find(f => f.id == r.forfaitId);
              return sum + (forfait?.nbPhotos || 0);
            }, 0);
          
          return {
            ...bobine,
            reserved,
            available: bobine.photosRestantes - reserved
          };
        });

        return bobinesWithReservations.find(b => b.available >= photosNeeded);
      };

      useEffect(() => {
        const today = new Date().toISOString().split('T')[0];
        
        reservations.forEach(res => {
          if (res.dateFin < today && res.bobineId && !res.bobineConsommee) {
            const forfait = forfaits.find(f => f.id == res.forfaitId);
            if (forfait && forfait.nbPhotos) {
              setBobines(prevBobines => 
                prevBobines.map(b => 
                  b.id === res.bobineId 
                    ? { ...b, photosRestantes: Math.max(0, b.photosRestantes - forfait.nbPhotos) }
                    : b
                )
              );
              
              setReservations(prevRes => 
                prevRes.map(r => 
                  r.id === res.id 
                    ? { ...r, bobineConsommee: true }
                    : r
                )
              );

              addNotification('info', '📦 Bobine dégrevée', `${forfait.nbPhotos} photos`, 'normal');
            }
          }
        });
      }, [reservations, forfaits, bobines]);

      const addNotification = (type, title, message, priority = 'normal') => {
        const newNotif = {
          id: Date.now(),
          type,
          title,
          message,
          priority,
          date: new Date().toISOString(),
          read: false
        };
        setNotifications(prev => [newNotif, ...prev]);
        
        if (notificationSettings.telegram?.enabled && priority !== 'normal') {
          sendTelegramNotification(title, message);
        }
      };

      const sendTelegramNotification = async (title, message) => {
        if (!notificationSettings.telegram?.botToken || !notificationSettings.telegram?.chatId) return;
        
        try {
          const text = `🔔 *${title}*\n\n${message}`;
          const url = `https://api.telegram.org/bot${notificationSettings.telegram.botToken}/sendMessage`;
          
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: notificationSettings.telegram.chatId,
              text: text,
              parse_mode: 'Markdown'
            })
          });
        } catch (error) {
          console.error('Erreur Telegram:', error);
        }
      };

      const markAsRead = (id) => {
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
      };

      const deleteNotification = (id) => {
        setNotifications(prev => prev.filter(n => n.id !== id));
      };

      const unreadCount = notifications.filter(n => !n.read).length;

      const openReservationModal = (prefilledDate = null) => {
        setModalType('reservation');
        setEditingItem(null);
        const dateStr = prefilledDate ? formatDateLocal(prefilledDate) : '';
        setFormData({
          type: 'reservation',
          borneId: '',
          forfaitId: '',
          clientNom: '',
          clientTel: '',
          dateDebut: dateStr,
          heureDebut: '10:00',
          dateFin: dateStr,
          heureFin: '23:00',
          lieuRetrait: '',
          lieuRetour: '',
          theme: '',
          themeRealisé: false,
          bobineId: null,
          bobineConsommee: false
        });
        setShowAddModal(true);
        setShowDateMenu(null);
      };

      const openRdvModal = (prefilledDate = null) => {
        setModalType('rdv');
        setEditingItem(null);
        const dateStr = prefilledDate ? formatDateLocal(prefilledDate) : '';
        setFormData({
          type: 'rdv',
          date: dateStr,
          heure: '10:00',
          clientNom: '',
          clientTel: '',
          lieu: '',
          description: ''
        });
        setShowAddModal(true);
        setShowDateMenu(null);
      };

      const handleSave = () => {
        if (modalType === 'borne') {
          if (editingItem) {
            setBornes(bornes.map(b => b.id === editingItem.id ? { ...formData, id: editingItem.id } : b));
          } else {
            setBornes([...bornes, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'forfait') {
          if (editingItem) {
            setForfaits(forfaits.map(f => f.id === editingItem.id ? { ...formData, id: editingItem.id } : f));
          } else {
            setForfaits([...forfaits, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'reservation') {
          const forfait = forfaits.find(f => f.id == formData.forfaitId);
          let finalData = { ...formData };
          
          if (forfait && forfait.nbPhotos && !editingItem) {
            const bobineDisponible = findAvailableBobine(forfait.nbPhotos);
            if (bobineDisponible) {
              finalData.bobineId = bobineDisponible.id;
              addNotification('info', '✅ Bobine attribuée', `Bobine #${bobineDisponible.numero}`, 'normal');
            } else {
              addNotification('warning', '⚠️ Pas de bobine', `Aucune bobine pour ${forfait.nbPhotos} photos`, 'high');
            }
          }
          
          if (editingItem) {
            setReservations(reservations.map(r => r.id === editingItem.id ? { ...finalData, id: editingItem.id } : r));
          } else {
            setReservations([...reservations, { ...finalData, id: Date.now() }]);
          }
        } else if (modalType === 'rdv') {
          if (editingItem) {
            setRdvs(rdvs.map(r => r.id === editingItem.id ? { ...formData, id: editingItem.id } : r));
          } else {
            setRdvs([...rdvs, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'stock') {
          if (editingItem) {
            setStock(stock.map(s => s.id === editingItem.id ? { ...formData, id: editingItem.id } : s));
          } else {
            setStock([...stock, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'bobine') {
          if (editingItem) {
            setBobines(bobines.map(b => b.id === editingItem.id ? { ...formData, id: editingItem.id } : b));
          } else {
            const newBobine = {
              ...formData,
              id: Date.now(),
              photosRestantes: formData.capacite,
              dateAjout: new Date().toISOString().split('T')[0]
            };
            setBobines([...bobines, newBobine]);
          }
        }
        setShowAddModal(false);
      };

      const handleDelete = (type, id) => {
        if (type === 'borne') setBornes(bornes.filter(b => b.id !== id));
        else if (type === 'forfait') setForfaits(forfaits.filter(f => f.id !== id));
        else if (type === 'reservation') setReservations(reservations.filter(r => r.id !== id));
        else if (type === 'rdv') setRdvs(rdvs.filter(r => r.id !== id));
        else if (type === 'stock') setStock(stock.filter(s => s.id !== id));
        else if (type === 'bobine') setBobines(bobines.filter(b => b.id !== id));
        setConfirmDelete(null);
      };

      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        return { daysInMonth, startingDayOfWeek, year, month };
      };

      const getEventsForDay = (day) => {
        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // Pour les réservations, afficher sur tous les jours entre dateDebut et dateFin
        const dayReservations = reservations.filter(r => {
          const debut = new Date(r.dateDebut);
          const fin = new Date(r.dateFin);
          const current = new Date(dateStr);
          return current >= debut && current <= fin;
        });
        
        const dayRdvs = rdvs.filter(r => r.date === dateStr);
        return [...dayReservations, ...dayRdvs];
      };

      const toggleThemeRealise = (resId) => {
        setReservations(reservations.map(r => r.id === resId ? { ...r, themeRealisé: !r.themeRealisé } : r));
      };

      // Fonction pour formater une date en YYYY-MM-DD en local (évite le décalage UTC)
      const formatDateLocal = (date) => {
        if (!date) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const themesAPreparer = reservations.filter(r => r.theme && !r.themeRealisé);

      const renderCalendar = () => {
        const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
        const days = [];
        
        for (let i = 0; i < startingDayOfWeek; i++) {
          days.push(<div key={`empty-${i}`} className="h-20 bg-gray-50"></div>);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          const events = getEventsForDay(day);
          const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
          
          days.push(
            <div
              key={day}
              className="h-20 border border-gray-200 p-1 bg-white hover:bg-gray-50 cursor-pointer relative text-xs"
              onClick={(e) => {
                e.stopPropagation();
                if (e.target === e.currentTarget || e.target.classList.contains('font-bold')) {
                  const rect = e.currentTarget.getBoundingClientRect();
                  const x = Math.min(rect.left + rect.width / 2, window.innerWidth - 200);
                  const y = Math.min(rect.top + rect.height / 2, window.innerHeight - 120);
                  setShowDateMenu({ day, x, y, date });
                }
              }}
            >
              <div className="font-bold text-xs">{day}</div>
              <div className="text-xs space-y-1 overflow-hidden">
                {events.slice(0, 1).map((event, idx) => (
                  <div
                    key={idx}
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowEventDetail(event);
                    }}
                    className={`px-1 py-0.5 rounded text-white truncate cursor-pointer hover:opacity-80 text-xs ${
                      event.type === 'reservation' ? 'bg-blue-500' : 'bg-green-500'
                    }`}
                  >
                    {event.type === 'reservation' ? '📷' : '📅'} {event.clientNom || event.description}
                  </div>
                ))}
                {events.length > 1 && (
                  <div 
                    className="text-xs text-blue-600 font-bold cursor-pointer hover:text-blue-800"
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowDayEvents({ day, events, date });
                    }}
                  >
                    +{events.length - 1} ▼
                  </div>
                )}
              </div>
            </div>
          );
        }
        
        return days;
      };

      // Formater la date de dernière sauvegarde
      const formatLastBackup = () => {
        if (!lastBackup) return 'Jamais';
        const date = new Date(lastBackup);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMins < 1) return 'À l\'instant';
        if (diffMins < 60) return `Il y a ${diffMins}min`;
        if (diffHours < 24) return `Il y a ${diffHours}h`;
        if (diffDays < 7) return `Il y a ${diffDays}j`;
        return date.toLocaleDateString('fr-FR');
      };

      return (
        <div className="min-h-screen bg-gray-100">
          <div className="sticky top-0 z-30 bg-white shadow-md">
            <div className="max-w-7xl mx-auto px-2">
              <div className="flex justify-between items-center py-2">
                <h1 className="text-lg font-bold text-blue-600">📷 Calendri-Booth</h1>
                
                <div className="flex gap-1 items-center text-xs">
                  {/* Boutons déplacés dans les paramètres */}
                </div>
              </div>

              <nav className="flex gap-1 border-b border-gray-200 pb-1 text-xs">
                <button
                  onClick={() => { setView('calendar'); setShowNotifications(false); }}
                  className={`px-2 py-1 rounded-t-lg ${
                    view === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                  }`}
                >
                  📅
                </button>
                <button
                  onClick={() => { setView('admin'); setShowNotifications(false); }}
                  className={`px-2 py-1 rounded-t-lg ${
                    view === 'admin' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                  }`}
                >
                  ⚙️
                </button>
                <button
                  onClick={() => { setView('settings'); setShowNotifications(false); }}
                  className={`px-2 py-1 rounded-t-lg ${
                    view === 'settings' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                  }`}
                >
                  🔧
                </button>
                <button
                  onClick={() => setShowNotifications(!showNotifications)}
                  className="ml-auto px-2 py-1 rounded-t-lg bg-gray-200 relative"
                >
                  🔔
                  {unreadCount > 0 && (
                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold">
                      {unreadCount}
                    </span>
                  )}
                </button>
              </nav>
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-2 text-sm">
            {showNotifications && (
              <div className="mb-4 bg-white rounded-lg shadow p-3">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-lg font-bold">🔔 Notifications</h2>
                </div>
                {notifications.length === 0 ? (
                  <p className="text-gray-500 text-center py-4 text-sm">Aucune notification</p>
                ) : (
                  <div className="space-y-2">
                    {notifications.slice(0, 10).map(notif => (
                      <div key={notif.id} className={`p-2 rounded text-xs ${notif.read ? 'opacity-60' : ''}`}>
                        <div className="flex justify-between">
                          <span className="font-bold">{notif.title}</span>
                          <button onClick={() => deleteNotification(notif.id)} className="text-red-500">✕</button>
                        </div>
                        <p className="text-xs">{notif.message}</p>
                        <p className="text-xs text-gray-400">{new Date(notif.date).toLocaleString('fr-FR')}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {view === 'settings' && (
              <div className="bg-white rounded-lg shadow p-4 mb-3">
                <h2 className="text-lg font-bold mb-3">🔧 Paramètres</h2>
                
                <div className="space-y-4">
                  {/* Section Google Drive */}
                  <div className="border-b pb-3">
                    <h3 className="font-bold text-sm mb-2">☁️ Google Drive</h3>
                    {accessToken ? (
                      <div className="space-y-2">
                        <div className="flex gap-2">
                          <button
                            onClick={() => saveToDrive(false)}
                            disabled={backupStatus === 'saving'}
                            className={`flex-1 px-3 py-2 text-xs rounded ${
                              backupStatus === 'saving' ? 'bg-gray-300' :
                              backupStatus === 'success' ? 'bg-green-500 text-white' :
                              backupStatus === 'error' ? 'bg-red-500 text-white' :
                              'bg-blue-500 text-white hover:bg-blue-600'
                            }`}
                          >
                            {backupStatus === 'saving' ? '💾 Sauvegarde...' :
                             backupStatus === 'success' ? '✅ Sauvegarde réussie' :
                             backupStatus === 'error' ? '❌ Erreur' :
                             '💾 Sauvegarder sur Drive'}
                          </button>
                          <button
                            onClick={handleGoogleSignOut}
                            className="px-3 py-2 text-xs bg-gray-500 text-white rounded"
                          >
                            ⏏️ Déconnexion
                          </button>
                        </div>
                        <div className="text-xs text-gray-600">
                          Dernière sauvegarde: {formatLastBackup()}
                          {nextAutoBackup && (
                            <div className="mt-1">
                              🤖 Prochaine sauvegarde auto: {getTimeUntilNextBackup()}
                            </div>
                          )}
                        </div>
                      </div>
                    ) : (
                      <button
                        onClick={handleGoogleSignIn}
                        className="w-full px-3 py-2 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                      >
                        🔐 Connexion à Google Drive
                      </button>
                    )}
                  </div>

                  {/* Section Import/Export */}
                  <div className="border-b pb-3">
                    <h3 className="font-bold text-sm mb-2">📦 Import / Export</h3>
                    <div className="flex gap-2">
                      <button
                        onClick={exportData}
                        className="flex-1 px-3 py-2 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                      >
                        📥 Exporter les données
                      </button>
                      
                      <label className="flex-1 px-3 py-2 text-xs bg-orange-500 text-white rounded hover:bg-orange-600 cursor-pointer text-center">
                        📤 Importer les données
                        <input type="file" accept=".json" onChange={importData} className="hidden" />
                      </label>
                    </div>
                  </div>
                  
                  <div>
                    <h3 className="font-bold text-sm mb-2">💾 Sauvegarde automatique Google Drive</h3>
                    {accessToken ? (
                      <div className="space-y-2">
                        <div className="flex items-center gap-2">
                          <label className="text-xs">Intervalle (minutes):</label>
                          <select 
                            value={notificationSettings.autoBackupInterval} 
                            onChange={(e) => setNotificationSettings({...notificationSettings, autoBackupInterval: parseInt(e.target.value)})}
                            className="p-1 border rounded text-xs"
                          >
                            <option value="15">15 min</option>
                            <option value="30">30 min</option>
                            <option value="60">1 heure</option>
                            <option value="180">3 heures</option>
                            <option value="360">6 heures</option>
                            <option value="720">12 heures</option>
                            <option value="1440">24 heures</option>
                          </select>
                        </div>
                        <div className="text-xs text-gray-600">
                          <div>✅ Connecté à Google Drive</div>
                          <div>📅 Dernière sauvegarde: {formatLastBackup()}</div>
                          {nextAutoBackup && <div>⏰ Prochaine sauvegarde: dans {getTimeUntilNextBackup()}</div>}
                        </div>
                      </div>
                    ) : (
                      <div className="text-xs text-gray-600">
                        ❌ Non connecté. Cliquez sur "🔐 Drive" en haut pour activer la sauvegarde automatique.
                      </div>
                    )}
                  </div>

                  <div className="border-t pt-3">
                    <h3 className="font-bold text-sm mb-2">ℹ️ Informations</h3>
                    <div className="text-xs space-y-1">
                      <div>Version: 2.0.0</div>
                      <div>📦 Bornes: {bornes.length}</div>
                      <div>📷 Réservations: {reservations.length}</div>
                      <div>📅 RDV: {rdvs.length}</div>
                      <div>🎞️ Bobines: {bobines.length}</div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {view === 'calendar' && (
              <>
                <div className="bg-white rounded-lg shadow p-3 mb-3">
                  <div className="flex justify-between items-center mb-2">
                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">←</button>
                    <h2 className="text-sm font-bold">{currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h2>
                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">→</button>
                  </div>
                  
                  <div className="grid grid-cols-7 gap-1 text-center mb-1">
                    {['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'].map(day => (
                      <div key={day} className="font-bold text-xs text-gray-600">{day}</div>
                    ))}
                  </div>
                  
                  <div className="grid grid-cols-7 gap-1">
                    {renderCalendar()}
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow p-3 mb-3">
                  <h3 className="font-bold mb-2 text-sm">📋 Récapitulatif du mois</h3>
                  {reservations.filter(r => {
                    const resDate = new Date(r.dateDebut);
                    return resDate.getMonth() === currentDate.getMonth() && resDate.getFullYear() === currentDate.getFullYear();
                  }).length === 0 && rdvs.filter(r => {
                    const rdvDate = new Date(r.date);
                    return rdvDate.getMonth() === currentDate.getMonth() && rdvDate.getFullYear() === currentDate.getFullYear();
                  }).length === 0 ? (
                    <p className="text-gray-500 text-center py-4 text-sm">Aucun événement ce mois-ci</p>
                  ) : (
                    <div className="space-y-3">
                      {reservations.filter(r => {
                        const resDate = new Date(r.dateDebut);
                        return resDate.getMonth() === currentDate.getMonth() && resDate.getFullYear() === currentDate.getFullYear();
                      }).map(res => {
                        const borne = bornes.find(b => b.id == res.borneId);
                        const forfait = forfaits.find(f => f.id == res.forfaitId);
                        return (
                          <div key={res.id} className="p-2 bg-blue-50 rounded text-xs border-l-4 border-blue-500">
                            <div className="font-bold text-blue-700">📷 {res.clientNom} - {res.clientTel}</div>
                            <div className="text-blue-600 font-bold mt-1">
                              📅 Du {new Date(res.dateDebut).toLocaleDateString('fr-FR')} à {res.heureDebut}
                              <br/>au {new Date(res.dateFin).toLocaleDateString('fr-FR')} à {res.heureFin}
                            </div>
                            <div className="border-t border-blue-200 mt-2 pt-2 space-y-1">
                              <div><strong>Borne:</strong> {borne?.nom || 'N/A'}</div>
                              <div><strong>Forfait:</strong> {forfait?.nom || 'N/A'}</div>
                              {res.lieuRetrait && <div><strong>📍 Lieu de retrait:</strong> {res.lieuRetrait}</div>}
                              {res.lieuRetour && <div><strong>📍 Lieu de retour:</strong> {res.lieuRetour}</div>}
                              {res.theme && (
                                <div className="flex items-center gap-1">
                                  <strong>🎨 Thème:</strong> {res.theme}
                                  <button onClick={() => toggleThemeRealise(res.id)} className={`ml-auto px-2 py-0.5 rounded text-xs ${res.themeRealisé ? 'bg-green-500 text-white' : 'bg-gray-300'}`}>
                                    {res.themeRealisé ? '✓ Fait' : 'À faire'}
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                      
                      {rdvs.filter(r => {
                        const rdvDate = new Date(r.date);
                        return rdvDate.getMonth() === currentDate.getMonth() && rdvDate.getFullYear() === currentDate.getFullYear();
                      }).map(rdv => (
                        <div key={rdv.id} className="p-2 bg-green-50 rounded text-xs border-l-4 border-green-500">
                          <div className="font-bold text-green-700">📅 {rdv.clientNom} - {rdv.clientTel}</div>
                          <div className="text-green-600 font-bold mt-1">
                            📅 {new Date(rdv.date).toLocaleDateString('fr-FR')} à {rdv.heure}
                          </div>
                          {rdv.description && (
                            <div className="mt-2 pt-2 border-t border-green-200">
                              <strong>Description:</strong> {rdv.description}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {themesAPreparer.length > 0 && (
                  <div className="bg-white rounded-lg shadow p-3 mb-3">
                    <h3 className="font-bold mb-2 text-sm">🎨 Thèmes à préparer</h3>
                    <div className="space-y-2">
                      {themesAPreparer.map(res => (
                        <div key={res.id} className="p-2 bg-yellow-50 rounded flex justify-between items-center text-xs">
                          <div>
                            <div className="font-bold">{res.clientNom}</div>
                            <div className="text-xs text-gray-600">{res.theme}</div>
                            <div className="text-xs text-gray-500">📅 {new Date(res.dateDebut).toLocaleDateString('fr-FR')}</div>
                          </div>
                          <button onClick={() => toggleThemeRealise(res.id)} className="px-2 py-1 bg-green-500 text-white rounded text-xs">
                            ✓ Fait
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}

            {view === 'admin' && (
              <div className="space-y-3">
                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">🖥️ Bornes</h3>
                    <button onClick={() => { setModalType('borne'); setFormData({}); setEditingItem(null); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+ Ajouter</button>
                  </div>
                  {bornes.length === 0 ? (
                    <p className="text-gray-500 text-center py-4 text-sm">Aucune borne</p>
                  ) : (
                    <div className="space-y-2">
                      {bornes.map(b => (
                        <div key={b.id} className="p-2 bg-gray-50 rounded flex justify-between items-center text-xs">
                          <div>
                            <div className="font-bold">{b.nom}</div>
                            <div className="text-xs text-gray-600">{b.modele}</div>
                          </div>
                          <div className="flex gap-1">
                            <button onClick={() => { setEditingItem(b); setFormData(b); setModalType('borne'); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">✏️</button>
                            <button onClick={() => setConfirmDelete({ type: 'borne', id: b.id })} className="px-2 py-1 bg-red-500 text-white rounded text-xs">🗑️</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">💰 Forfaits</h3>
                    <button onClick={() => { setModalType('forfait'); setFormData({}); setEditingItem(null); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+ Ajouter</button>
                  </div>
                  {forfaits.length === 0 ? (
                    <p className="text-gray-500 text-center py-4 text-sm">Aucun forfait</p>
                  ) : (
                    <div className="space-y-2">
                      {forfaits.map(f => (
                        <div key={f.id} className="p-2 bg-gray-50 rounded flex justify-between items-center text-xs">
                          <div>
                            <div className="font-bold">{f.nom}</div>
                            <div className="text-xs text-gray-600">{f.prix}€ - {f.duree} - {f.nbPhotos} photos</div>
                          </div>
                          <div className="flex gap-1">
                            <button onClick={() => { setEditingItem(f); setFormData(f); setModalType('forfait'); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">✏️</button>
                            <button onClick={() => setConfirmDelete({ type: 'forfait', id: f.id })} className="px-2 py-1 bg-red-500 text-white rounded text-xs">🗑️</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">📦 Bobines</h3>
                    <button onClick={() => { setModalType('bobine'); setFormData({ capacite: 400 }); setEditingItem(null); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+ Ajouter</button>
                  </div>
                  {bobines.length === 0 ? (
                    <p className="text-gray-500 text-center py-4 text-sm">Aucune bobine</p>
                  ) : (
                    <div className="space-y-2">
                      {bobines.map(b => {
                        const reserved = reservations
                          .filter(r => r.bobineId === b.id && !r.bobineConsommee)
                          .reduce((sum, r) => {
                            const forfait = forfaits.find(f => f.id == r.forfaitId);
                            return sum + (forfait?.nbPhotos || 0);
                          }, 0);
                        const available = b.photosRestantes - reserved;
                        
                        return (
                          <div key={b.id} className="p-2 bg-gray-50 rounded text-xs">
                            <div className="flex justify-between items-center mb-1">
                              <div className="font-bold">Bobine #{b.numero}</div>
                              <div className="flex gap-1">
                                <button onClick={() => { setEditingItem(b); setFormData(b); setModalType('bobine'); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">✏️</button>
                                <button onClick={() => setConfirmDelete({ type: 'bobine', id: b.id })} className="px-2 py-1 bg-red-500 text-white rounded text-xs">🗑️</button>
                              </div>
                            </div>
                            <div className="text-xs space-y-0.5">
                              <div>📸 Capacité: {b.capacite} photos</div>
                              <div>✅ Disponibles: {b.photosRestantes} photos</div>
                              {reserved > 0 && <div className="text-orange-600">🔒 Réservées: {reserved} photos</div>}
                              <div className={`font-bold ${available < 50 ? 'text-red-600' : 'text-green-600'}`}>
                                💡 Utilisables: {available} photos
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">📦 Stock</h3>
                    <button onClick={() => { setModalType('stock'); setFormData({}); setEditingItem(null); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+ Ajouter</button>
                  </div>
                  {stock.length === 0 ? (
                    <p className="text-gray-500 text-center py-4 text-sm">Aucun article en stock</p>
                  ) : (
                    <div className="space-y-2">
                      {stock.map(s => (
                        <div key={s.id} className="p-2 bg-gray-50 rounded flex justify-between items-center text-xs">
                          <div>
                            <div className="font-bold">{s.nom}</div>
                            <div className={`text-xs ${s.quantite <= s.seuilAlerte ? 'text-red-600 font-bold' : 'text-gray-600'}`}>
                              Quantité: {s.quantite} {s.quantite <= s.seuilAlerte && '⚠️'}
                            </div>
                          </div>
                          <div className="flex gap-1">
                            <button onClick={() => { setEditingItem(s); setFormData(s); setModalType('stock'); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">✏️</button>
                            <button onClick={() => setConfirmDelete({ type: 'stock', id: s.id })} className="px-2 py-1 bg-red-500 text-white rounded text-xs">🗑️</button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          <div className="fixed top-20 right-3 flex flex-col gap-2 z-20">
            <button onClick={() => openReservationModal()} className="w-12 h-12 bg-purple-500 text-white rounded-full shadow-lg flex items-center justify-center text-xl hover:bg-purple-600">📷</button>
            <button onClick={() => openRdvModal()} className="w-12 h-12 bg-pink-500 text-white rounded-full shadow-lg flex items-center justify-center text-xl hover:bg-pink-600">👥</button>
          </div>

          {showDateMenu && (
            <div
              className="fixed bg-white rounded-lg shadow-lg p-2 z-40 text-sm"
              style={{ left: `${showDateMenu.x}px`, top: `${showDateMenu.y}px`, transform: 'translate(-50%, -50%)' }}
            >
              <button onClick={() => openReservationModal(showDateMenu.date)} className="w-full px-3 py-2 text-left hover:bg-gray-100 rounded text-xs">📷 Réservation</button>
              <button onClick={() => openRdvModal(showDateMenu.date)} className="w-full px-3 py-2 text-left hover:bg-gray-100 rounded text-xs">📅 RDV</button>
              <button onClick={() => setShowDateMenu(null)} className="w-full px-3 py-2 text-left hover:bg-gray-100 rounded text-xs text-gray-500">✕ Annuler</button>
            </div>
          )}

          {showDateMenu && (
            <>
              <div className="fixed inset-0 z-30" onClick={() => setShowDateMenu(null)}></div>
            </>
          )}

          {showEventDetail && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[80vh] overflow-y-auto text-sm">
                <div className="flex justify-between mb-3">
                  <h3 className="font-bold text-sm">{showEventDetail.type === 'reservation' ? '📷 Location' : '📅 RDV'}</h3>
                  <button onClick={() => setShowEventDetail(null)} className="text-xl">✕</button>
                </div>
                <div className="space-y-2 text-xs">
                  <div><strong>Client:</strong> {showEventDetail.clientNom}</div>
                  <div><strong>Tél:</strong> {showEventDetail.clientTel}</div>
                  {showEventDetail.type === 'reservation' && (
                    <>
                      {(() => {
                        const borne = bornes.find(b => b.id == showEventDetail.borneId);
                        const forfait = forfaits.find(f => f.id == showEventDetail.forfaitId);
                        const bobine = bobines.find(b => b.id == showEventDetail.bobineId);
                        return (
                          <>
                            {borne && <div><strong>Borne:</strong> {borne.nom} - {borne.modele}</div>}
                            {forfait && <div><strong>Forfait:</strong> {forfait.nom} ({forfait.nbPhotos} photos)</div>}
                            {bobine && <div><strong>Bobine:</strong> Bobine #{bobine.numero}</div>}
                          </>
                        );
                      })()}
                      <div><strong>Retrait:</strong> {showEventDetail.dateDebut} à {showEventDetail.heureDebut}</div>
                      <div><strong>Retour:</strong> {showEventDetail.dateFin} à {showEventDetail.heureFin}</div>
                      {showEventDetail.lieuRetrait && <div><strong>Lieu de retrait:</strong> {showEventDetail.lieuRetrait}</div>}
                      {showEventDetail.lieuRetour && <div><strong>Lieu de retour:</strong> {showEventDetail.lieuRetour}</div>}
                      {showEventDetail.theme && <div><strong>Thème:</strong> {showEventDetail.theme}</div>}
                    </>
                  )}
                  {showEventDetail.type === 'rdv' && (
                    <>
                      {showEventDetail.lieu && <div><strong>Lieu:</strong> {showEventDetail.lieu}</div>}
                      {showEventDetail.description && <div><strong>Description:</strong> {showEventDetail.description}</div>}
                    </>
                  )}
                </div>
                <div className="flex gap-2 mt-3">
                  <button onClick={() => { setEditingItem(showEventDetail); setFormData(showEventDetail); setModalType(showEventDetail.type); setShowEventDetail(null); setShowAddModal(true); }} className="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs">✏️ Modifier</button>
                  <button onClick={() => { setConfirmDelete({ type: showEventDetail.type, id: showEventDetail.id }); setShowEventDetail(null); }} className="flex-1 px-3 py-2 bg-red-500 text-white rounded text-xs">🗑️ Supprimer</button>
                </div>
              </div>
            </div>
          )}

          {showDayEvents && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-3">
                  <h3 className="font-bold text-base">📅 {showDayEvents.day} {currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h3>
                  <button onClick={() => setShowDayEvents(null)} className="text-xl">✕</button>
                </div>
                <div className="space-y-2">
                  {showDayEvents.events.map((event, idx) => (
                    <div
                      key={idx}
                      onClick={() => {
                        setShowDayEvents(null);
                        setShowEventDetail(event);
                      }}
                      className={`p-3 rounded cursor-pointer hover:opacity-80 transition-opacity ${
                        event.type === 'reservation' ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-green-50 border-l-4 border-green-500'
                      }`}
                    >
                      <div className="flex items-start gap-2">
                        <div className="text-2xl">{event.type === 'reservation' ? '📷' : '📅'}</div>
                        <div className="flex-1 text-sm">
                          <div className="font-bold">{event.clientNom}</div>
                          <div className="text-xs text-gray-600">{event.clientTel}</div>
                          {event.type === 'reservation' && (
                            <div className="text-xs text-gray-500 mt-1">
                              {event.heureDebut} - {event.heureFin}
                            </div>
                          )}
                          {event.type === 'rdv' && (
                            <div className="text-xs text-gray-500 mt-1">
                              {event.heure}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="mt-3 flex gap-2">
                  <button 
                    onClick={() => {
                      setShowDayEvents(null);
                      openReservationModal(showDayEvents.date);
                    }} 
                    className="flex-1 px-3 py-2 bg-purple-500 text-white rounded text-xs hover:bg-purple-600"
                  >
                    📷 Nouvelle location
                  </button>
                  <button 
                    onClick={() => {
                      setShowDayEvents(null);
                      openRdvModal(showDayEvents.date);
                    }} 
                    className="flex-1 px-3 py-2 bg-pink-500 text-white rounded text-xs hover:bg-pink-600"
                  >
                    📅 Nouveau RDV
                  </button>
                </div>
              </div>
            </div>
          )}

          {showAddModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[80vh] overflow-y-auto text-sm">
                <h3 className="font-bold mb-3 text-sm">{editingItem ? 'Modifier' : 'Ajouter'}</h3>
                
                {modalType === 'borne' && (
                  <div className="space-y-2">
                    <input type="text" placeholder="Nom" value={formData.nom || ''} onChange={(e) => setFormData({ ...formData, nom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Modèle" value={formData.modele || ''} onChange={(e) => setFormData({ ...formData, modele: e.target.value })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'forfait' && (
                  <div className="space-y-2">
                    <input type="text" placeholder="Nom" value={formData.nom || ''} onChange={(e) => setFormData({ ...formData, nom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Prix (€)" value={formData.prix || ''} onChange={(e) => setFormData({ ...formData, prix: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Durée" value={formData.duree || ''} onChange={(e) => setFormData({ ...formData, duree: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Nb photos" value={formData.nbPhotos || ''} onChange={(e) => setFormData({ ...formData, nbPhotos: parseInt(e.target.value) || '' })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'bobine' && (
                  <div className="space-y-2">
                    <input type="number" placeholder="Numéro" value={formData.numero || ''} onChange={(e) => setFormData({ ...formData, numero: parseInt(e.target.value) || '' })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Capacité" value={formData.capacite || ''} onChange={(e) => setFormData({ ...formData, capacite: parseInt(e.target.value) || 400 })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'stock' && (
                  <div className="space-y-2">
                    <input type="text" placeholder="Nom" value={formData.nom || ''} onChange={(e) => setFormData({ ...formData, nom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Quantité" value={formData.quantite || ''} onChange={(e) => setFormData({ ...formData, quantite: parseInt(e.target.value) || 0 })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Seuil" value={formData.seuilAlerte || ''} onChange={(e) => setFormData({ ...formData, seuilAlerte: parseInt(e.target.value) || 0 })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'reservation' && (
                  <div className="space-y-2">
                    <select value={formData.borneId || ''} onChange={(e) => setFormData({ ...formData, borneId: e.target.value })} className="w-full p-2 border rounded text-sm">
                      <option value="">Borne</option>
                      {bornes.map(b => <option key={b.id} value={b.id}>{b.nom}</option>)}
                    </select>
                    <select value={formData.forfaitId || ''} onChange={(e) => setFormData({ ...formData, forfaitId: e.target.value })} className="w-full p-2 border rounded text-sm">
                      <option value="">Forfait</option>
                      {forfaits.map(f => <option key={f.id} value={f.id}>{f.nom}</option>)}
                    </select>
                    <input type="text" placeholder="Client" value={formData.clientNom || ''} onChange={(e) => setFormData({ ...formData, clientNom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="tel" placeholder="Téléphone" value={formData.clientTel || ''} onChange={(e) => setFormData({ ...formData, clientTel: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    
                    <div className="border-t pt-2">
                      <label className="block text-xs font-bold mb-1 text-blue-600">📍 RETRAIT</label>
                      <input type="date" value={formData.dateDebut || ''} onChange={(e) => setFormData({ ...formData, dateDebut: e.target.value })} className="w-full p-2 border rounded text-sm mb-1" />
                      <input type="time" value={formData.heureDebut || ''} onChange={(e) => setFormData({ ...formData, heureDebut: e.target.value })} className="w-full p-2 border rounded text-sm mb-1" />
                      <input type="text" placeholder="Lieu de retrait" value={formData.lieuRetrait || ''} onChange={(e) => setFormData({ ...formData, lieuRetrait: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    </div>
                    
                    <div className="border-t pt-2">
                      <label className="block text-xs font-bold mb-1 text-green-600">📍 RETOUR</label>
                      <input type="date" value={formData.dateFin || ''} onChange={(e) => setFormData({ ...formData, dateFin: e.target.value })} className="w-full p-2 border rounded text-sm mb-1" />
                      <input type="time" value={formData.heureFin || ''} onChange={(e) => setFormData({ ...formData, heureFin: e.target.value })} className="w-full p-2 border rounded text-sm mb-1" />
                      <input type="text" placeholder="Lieu de retour" value={formData.lieuRetour || ''} onChange={(e) => setFormData({ ...formData, lieuRetour: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    </div>
                    
                    <textarea placeholder="Thème" value={formData.theme || ''} onChange={(e) => setFormData({ ...formData, theme: e.target.value })} className="w-full p-2 border rounded text-sm h-16"></textarea>
                  </div>
                )}

                {modalType === 'rdv' && (
                  <div className="space-y-2">
                    <input type="date" value={formData.date || ''} onChange={(e) => setFormData({ ...formData, date: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="time" value={formData.heure || ''} onChange={(e) => setFormData({ ...formData, heure: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Client" value={formData.clientNom || ''} onChange={(e) => setFormData({ ...formData, clientNom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="tel" placeholder="Téléphone" value={formData.clientTel || ''} onChange={(e) => setFormData({ ...formData, clientTel: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Lieu / Adresse" value={formData.lieu || ''} onChange={(e) => setFormData({ ...formData, lieu: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <textarea placeholder="Description" value={formData.description || ''} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full p-2 border rounded text-sm h-16"></textarea>
                  </div>
                )}

                <div className="flex gap-2 mt-3">
                  <button onClick={handleSave} className="flex-1 px-3 py-2 bg-green-500 text-white rounded text-sm">✓ OK</button>
                  <button onClick={() => setShowAddModal(false)} className="flex-1 px-3 py-2 bg-gray-500 text-white rounded text-sm">✕ Annuler</button>
                </div>
              </div>
            </div>
          )}

          {confirmDelete && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-sm w-full text-sm">
                <h3 className="font-bold mb-3">Supprimer ?</h3>
                <div className="flex gap-2">
                  <button onClick={() => handleDelete(confirmDelete.type, confirmDelete.id)} className="flex-1 px-3 py-2 bg-red-500 text-white rounded text-sm">Supprimer</button>
                  <button onClick={() => setConfirmDelete(null)} className="flex-1 px-3 py-2 bg-gray-500 text-white rounded text-sm">Annuler</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Service Worker avec détection de mise à jour
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Calendrier-APP/service-worker.js')
          .then(reg => {
            console.log('✅ Service Worker enregistré');
            
            // Vérifier les mises à jour
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nouvelle version disponible
                  if (confirm('🔄 Une nouvelle version est disponible ! Recharger maintenant ?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch(err => console.error('❌ Erreur Service Worker:', err));
      });

      // Recharger quand le nouveau SW prend le contrôle
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });
    }

    // Installation PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      const installBtn = document.createElement('button');
      installBtn.textContent = '📱 Installer';
      installBtn.className = 'fixed bottom-20 left-4 px-4 py-2 bg-blue-500 text-white rounded-lg shadow-lg z-50 text-sm';
      installBtn.onclick = async () => {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.remove();
        }
        deferredPrompt = null;
      };
      document.body.appendChild(installBtn);
    });

    ReactDOM.render(<PhotoboothManager />, document.getElementById('root'));
  </script>
</body>
</html>
