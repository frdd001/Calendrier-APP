<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="Gestion de location de photobooths">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì∑</text></svg>">
  <title>Calendri-Booth</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ‚ö†Ô∏è REMPLACEZ ICI VOS CL√âS GOOGLE
    const CLIENT_ID = '362970811261-iemtpn2m017af2ja4qsqjsjbkou59cje.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyB7UaolNFtg__7qweEzNiwr40c4Gk13lQ8';
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';

    function PhotoboothManager() {
      const [view, setView] = useState('calendar');
      const [currentDate, setCurrentDate] = useState(new Date());
      const [bornes, setBornes] = useState([]);
      const [forfaits, setForfaits] = useState([]);
      const [reservations, setReservations] = useState([]);
      const [rdvs, setRdvs] = useState([]);
      const [bobines, setBobines] = useState([]);
      const [stock, setStock] = useState([]);
      const [showAddModal, setShowAddModal] = useState(false);
      const [modalType, setModalType] = useState('');
      const [formData, setFormData] = useState({});
      const [editingItem, setEditingItem] = useState(null);
      const [confirmDelete, setConfirmDelete] = useState(null);
      const [showDateMenu, setShowDateMenu] = useState(null);
      const [showEventDetail, setShowEventDetail] = useState(null);
      const [notifications, setNotifications] = useState([]);
      const [showNotifications, setShowNotifications] = useState(false);
      const [notificationSettings, setNotificationSettings] = useState({
        telegram: { enabled: false, botToken: '', chatId: '' },
											   
        weeklyReminder: true,
        dailyReminder: true,
        urgentAlerts: true,
        stockAlerts: true
								 
      });
      const [isGapiLoaded, setIsGapiLoaded] = useState(false);
      const [isSignedIn, setIsSignedIn] = useState(false);
      const [lastBackup, setLastBackup] = useState(null);
      const [backupStatus, setBackupStatus] = useState('idle');

							   
      useEffect(() => {
        const initGapi = () => {
          if (typeof gapi !== 'undefined') {
            gapi.load('client:auth2', () => {
              gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
              }).then(() => {
                setIsGapiLoaded(true);
                const authInstance = gapi.auth2.getAuthInstance();
                setIsSignedIn(authInstance.isSignedIn.get());
                authInstance.isSignedIn.listen(setIsSignedIn);
                
                if (authInstance.isSignedIn.get()) {
                  loadFromDrive();
                }
              }).catch(err => {
                console.error('Erreur init Google API:', err);
              });
            });
          }
        };

        if (document.readyState === 'complete') {
          initGapi();
        } else {
          window.addEventListener('load', initGapi);
        }

        return () => window.removeEventListener('load', initGapi);
      }, []);

							   
      const handleGoogleSignIn = () => {
        if (isGapiLoaded) {
          gapi.auth2.getAuthInstance().signIn();
        }
      };

      const handleGoogleSignOut = () => {
        if (isGapiLoaded) {
          gapi.auth2.getAuthInstance().signOut();
        }
      };

									 
      const saveToDrive = async () => {
        if (!isSignedIn) {
          alert('Connectez-vous √† Google Drive pour sauvegarder');
          return;
        }

        setBackupStatus('saving');
        
        const data = {
          bornes,
          forfaits,
          reservations,
          rdvs,
          bobines,
          stock,
          notifications,
          notificationSettings,
          lastBackup: new Date().toISOString()
        };

        try {
												 
          const response = await gapi.client.drive.files.list({
            spaces: 'appDataFolder',
            fields: 'files(id, name)',
            q: "name='photobooth_backup.json'"
          });

          const boundary = '-------314159265358979323846';
          const delimiter = "\r\n--" + boundary + "\r\n";
          const close_delim = "\r\n--" + boundary + "--";

          const metadata = {
            name: 'photobooth_backup.json',
            mimeType: 'application/json'
          };

          const multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(metadata) +
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(data) +
            close_delim;

          let fileId = null;
          if (response.result.files && response.result.files.length > 0) {
            fileId = response.result.files[0].id;
          }

          const request = gapi.client.request({
            path: fileId 
              ? `/upload/drive/v3/files/${fileId}`
              : '/upload/drive/v3/files',
            method: fileId ? 'PATCH' : 'POST',
            params: {
              uploadType: 'multipart',
              ...(fileId ? {} : { fields: 'id' })
            },
            headers: {
              'Content-Type': 'multipart/related; boundary="' + boundary + '"'
            },
            body: multipartRequestBody
          });

          await request;
          
          setLastBackup(new Date().toISOString());
          setBackupStatus('success');
          addNotification('info', 'üíæ Sauvegarde r√©ussie', 'Donn√©es sauvegard√©es sur Google Drive', 'normal');
          
          setTimeout(() => setBackupStatus('idle'), 3000);
        } catch (error) {
          console.error('Erreur sauvegarde Drive:', error);
          setBackupStatus('error');
          addNotification('warning', '‚ö†Ô∏è Erreur sauvegarde', 'Impossible de sauvegarder sur Drive', 'high');
          setTimeout(() => setBackupStatus('idle'), 3000);
        }
      };

									
      const loadFromDrive = async () => {
        if (!isSignedIn) return;

        try {
          const response = await gapi.client.drive.files.list({
            spaces: 'appDataFolder',
            fields: 'files(id, name)',
            q: "name='photobooth_backup.json'"
          });

          if (response.result.files && response.result.files.length > 0) {
            const fileId = response.result.files[0].id;
            const file = await gapi.client.drive.files.get({
              fileId: fileId,
              alt: 'media'
            });

            const data = file.result;
            setBornes(data.bornes || []);
            setForfaits(data.forfaits || []);
            setReservations(data.reservations || []);
            setRdvs(data.rdvs || []);
            setBobines(data.bobines || []);
            setStock(data.stock || []);
            setNotifications(data.notifications || []);
            setNotificationSettings(data.notificationSettings || notificationSettings);
            setLastBackup(data.lastBackup);
            
            addNotification('info', '‚úÖ Donn√©es restaur√©es', 'Donn√©es charg√©es depuis Google Drive', 'normal');
          }
        } catch (error) {
          console.error('Erreur chargement Drive:', error);
													
          loadFromLocalStorage();
        }
      };

									
      const loadFromLocalStorage = () => {
        const savedBornes = localStorage.getItem('bornes');
        const savedForfaits = localStorage.getItem('forfaits');
        const savedReservations = localStorage.getItem('reservations');
        const savedRdvs = localStorage.getItem('rdvs');
        const savedBobines = localStorage.getItem('bobines');
        const savedStock = localStorage.getItem('stock');
        const savedNotifications = localStorage.getItem('notifications');
        const savedNotificationSettings = localStorage.getItem('notificationSettings');
        
        if (savedBornes) setBornes(JSON.parse(savedBornes));
        if (savedForfaits) setForfaits(JSON.parse(savedForfaits));
        if (savedReservations) setReservations(JSON.parse(savedReservations));
        if (savedRdvs) setRdvs(JSON.parse(savedRdvs));
        if (savedBobines) setBobines(JSON.parse(savedBobines));
        if (savedStock) setStock(JSON.parse(savedStock));
        if (savedNotifications) setNotifications(JSON.parse(savedNotifications));
        if (savedNotificationSettings) setNotificationSettings(JSON.parse(savedNotificationSettings));
      };

										   
      useEffect(() => {
        if (!isSignedIn) {
          loadFromLocalStorage();
        }
      }, []);

									  
      useEffect(() => {
        localStorage.setItem('bornes', JSON.stringify(bornes));
        localStorage.setItem('forfaits', JSON.stringify(forfaits));
        localStorage.setItem('reservations', JSON.stringify(reservations));
        localStorage.setItem('rdvs', JSON.stringify(rdvs));
        localStorage.setItem('bobines', JSON.stringify(bobines));
        localStorage.setItem('stock', JSON.stringify(stock));
        localStorage.setItem('notifications', JSON.stringify(notifications));
        localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
      }, [bornes, forfaits, reservations, rdvs, bobines, stock, notifications, notificationSettings]);

											  
      useEffect(() => {
        if (!isSignedIn) return;

        const autoBackup = setInterval(() => {
          saveToDrive();
        }, 24 * 60 * 60 * 1000);

        return () => clearInterval(autoBackup);
      }, [isSignedIn, bornes, forfaits, reservations, rdvs, bobines, stock]);

													
      const findAvailableBobine = (photosNeeded) => {
        const bobinesWithReservations = bobines.map(bobine => {
          const reserved = reservations
            .filter(r => r.bobineId === bobine.id && !r.bobineConsommee)
            .reduce((sum, r) => {
              const forfait = forfaits.find(f => f.id == r.forfaitId);
              return sum + (forfait?.nbPhotos || 0);
            }, 0);
          
          return {
            ...bobine,
            reserved,
            available: bobine.photosRestantes - reserved
          };
        });

        return bobinesWithReservations.find(b => b.available >= photosNeeded);
      };

											  
      useEffect(() => {
        const today = new Date().toISOString().split('T')[0];
        
        reservations.forEach(res => {
          if (res.dateFin < today && res.bobineId && !res.bobineConsommee) {
            const forfait = forfaits.find(f => f.id == res.forfaitId);
            if (forfait && forfait.nbPhotos) {
              setBobines(prevBobines => 
                prevBobines.map(b => 
                  b.id === res.bobineId 
                    ? { ...b, photosRestantes: Math.max(0, b.photosRestantes - forfait.nbPhotos) }
                    : b
                )
              );
              
              setReservations(prevRes => 
                prevRes.map(r => 
                  r.id === res.id 
                    ? { ...r, bobineConsommee: true }
                    : r
                )
              );

              addNotification('info', 'üì¶ Bobine d√©grev√©e', `Bobine d√©grev√©e de ${forfait.nbPhotos} photos`, 'normal');
            }
          }
        });
      }, [reservations, forfaits, bobines]);

      const addNotification = (type, title, message, priority = 'normal') => {
        const newNotif = {
          id: Date.now(),
          type,
          title,
          message,
          priority,
          date: new Date().toISOString(),
          read: false
        };
        setNotifications(prev => [newNotif, ...prev]);
        
        if (notificationSettings.telegram.enabled && priority !== 'normal') {
          sendTelegramNotification(title, message);
        }
      };

      const sendTelegramNotification = async (title, message) => {
        if (!notificationSettings.telegram.botToken || !notificationSettings.telegram.chatId) return;
        
        try {
          const text = `üîî *${title}*\n\n${message}`;
          const url = `https://api.telegram.org/bot${notificationSettings.telegram.botToken}/sendMessage`;
          
          await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: notificationSettings.telegram.chatId,
              text: text,
              parse_mode: 'Markdown'
            })
          });
        } catch (error) {
          console.error('Erreur Telegram:', error);
        }
      };

					   
										  
								 
														
										 
									  
		  
																					 
													   
													
											  
																  
												  
													   
															   
			   
			
									  
																													   
			 
		   
		  
																 
																				
																 
			
																 
																																		
			 
		   
		  
									   
													
															
			
										 
																												  
			 
			
										 
																														  
			 
			 
		  
														   
															  
																								 
													
			 
		  
																			 
																														
		   

																		  
																		
																											
		   

																		  
																		  
																														 
		   
		  
		
																		 
							 
		
											 
																	 

      const markAsRead = (id) => {
        setNotifications(prev => prev.map(n => n.id === id ? { ...n, read: true } : n));
      };

      const deleteNotification = (id) => {
        setNotifications(prev => prev.filter(n => n.id !== id));
      };

      const unreadCount = notifications.filter(n => !n.read).length;

      const openReservationModal = (prefilledDate = null) => {
        setModalType('reservation');
        setEditingItem(null);
        const dateStr = prefilledDate ? prefilledDate.toISOString().split('T')[0] : '';
        setFormData({
          type: 'reservation',
          borneId: '',
          forfaitId: '',
          clientNom: '',
          clientTel: '',
          dateDebut: dateStr,
          heureDebut: '10:00',
          dateFin: dateStr,
          heureFin: '23:00',
          lieuDepot: '',
          lieuRetour: '',
          theme: '',
          themeRealis√©: false,
          bobineId: null,
          bobineConsommee: false
        });
        setShowAddModal(true);
        setShowDateMenu(null);
      };

      const openRdvModal = (prefilledDate = null) => {
        setModalType('rdv');
        setEditingItem(null);
        const dateStr = prefilledDate ? prefilledDate.toISOString().split('T')[0] : '';
        setFormData({
          type: 'rdv',
          date: dateStr,
          heure: '10:00',
          clientNom: '',
          clientTel: '',
          description: ''
        });
        setShowAddModal(true);
        setShowDateMenu(null);
      };

      const handleSave = () => {
        if (modalType === 'borne') {
          if (editingItem) {
            setBornes(bornes.map(b => b.id === editingItem.id ? { ...formData, id: editingItem.id } : b));
          } else {
            setBornes([...bornes, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'forfait') {
          if (editingItem) {
            setForfaits(forfaits.map(f => f.id === editingItem.id ? { ...formData, id: editingItem.id } : f));
          } else {
            setForfaits([...forfaits, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'reservation') {
          const forfait = forfaits.find(f => f.id == formData.forfaitId);
          let finalData = { ...formData };
          
          if (forfait && forfait.nbPhotos && !editingItem) {
            const bobineDisponible = findAvailableBobine(forfait.nbPhotos);
            if (bobineDisponible) {
              finalData.bobineId = bobineDisponible.id;
              addNotification('info', '‚úÖ Bobine attribu√©e', `Bobine #${bobineDisponible.numero} attribu√©e`, 'normal');
            } else {
              addNotification('warning', '‚ö†Ô∏è Pas de bobine', `Aucune bobine disponible pour ${forfait.nbPhotos} photos`, 'high');
            }
          }
          
          if (editingItem) {
            setReservations(reservations.map(r => r.id === editingItem.id ? { ...finalData, id: editingItem.id } : r));
          } else {
            setReservations([...reservations, { ...finalData, id: Date.now() }]);
          }
        } else if (modalType === 'rdv') {
          if (editingItem) {
            setRdvs(rdvs.map(r => r.id === editingItem.id ? { ...formData, id: editingItem.id } : r));
          } else {
            setRdvs([...rdvs, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'stock') {
          if (editingItem) {
            setStock(stock.map(s => s.id === editingItem.id ? { ...formData, id: editingItem.id } : s));
          } else {
            setStock([...stock, { ...formData, id: Date.now() }]);
          }
        } else if (modalType === 'bobine') {
          if (editingItem) {
            setBobines(bobines.map(b => b.id === editingItem.id ? { ...formData, id: editingItem.id } : b));
          } else {
            const newBobine = {
              ...formData,
              id: Date.now(),
              photosRestantes: formData.capacite,
              dateAjout: new Date().toISOString().split('T')[0]
            };
            setBobines([...bobines, newBobine]);
																																	 
          }
        }
        setShowAddModal(false);
      };

      const handleDelete = (type, id) => {
        if (type === 'borne') setBornes(bornes.filter(b => b.id !== id));
        else if (type === 'forfait') setForfaits(forfaits.filter(f => f.id !== id));
        else if (type === 'reservation') setReservations(reservations.filter(r => r.id !== id));
        else if (type === 'rdv') setRdvs(rdvs.filter(r => r.id !== id));
        else if (type === 'stock') setStock(stock.filter(s => s.id !== id));
        else if (type === 'bobine') setBobines(bobines.filter(b => b.id !== id));
        setConfirmDelete(null);
      };

      const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();
        return { daysInMonth, startingDayOfWeek, year, month };
      };

      const getEventsForDay = (day) => {
        const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayReservations = reservations.filter(r => r.dateDebut === dateStr || r.dateFin === dateStr);
        const dayRdvs = rdvs.filter(r => r.date === dateStr);
        return [...dayReservations, ...dayRdvs];
      };

      const toggleThemeRealise = (resId) => {
        setReservations(reservations.map(r => r.id === resId ? { ...r, themeRealis√©: !r.themeRealis√© } : r));
      };

      const themesAPreparer = reservations.filter(r => r.theme && !r.themeRealis√©);

      const renderCalendar = () => {
        const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
        const days = [];
        
        for (let i = 0; i < startingDayOfWeek; i++) {
          days.push(<div key={`empty-${i}`} className="h-20 bg-gray-50"></div>);
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          const events = getEventsForDay(day);
          const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
          
          days.push(
            <div
              key={day}
              className="h-20 border border-gray-200 p-1 bg-white hover:bg-gray-50 cursor-pointer relative text-xs"
              onClick={(e) => {
                e.stopPropagation();
                if (e.target === e.currentTarget || e.target.classList.contains('font-bold')) {
                  const rect = e.currentTarget.getBoundingClientRect();
                  const x = Math.min(rect.left + rect.width / 2, window.innerWidth - 200);
                  const y = Math.min(rect.top + rect.height / 2, window.innerHeight - 120);
                  setShowDateMenu({ day, x, y, date });
                }
              }}
            >
              <div className="font-bold text-xs">{day}</div>
              <div className="text-xs space-y-1 overflow-hidden">
                {events.slice(0, 1).map((event, idx) => (
                  <div
                    key={idx}
                    onClick={(e) => {
                      e.stopPropagation();
                      setShowEventDetail(event);
                    }}
                    className={`px-1 py-0.5 rounded text-white truncate cursor-pointer hover:opacity-80 text-xs ${
                      event.type === 'reservation' ? 'bg-blue-500' : 'bg-green-500'
                    }`}
                  >
                    {event.type === 'reservation' ? 'üì∑' : 'üìÖ'} {event.clientNom || event.description}
                  </div>
                ))}
                {events.length > 1 && (
                  <div className="text-xs text-gray-500">+{events.length - 1}</div>
                )}
              </div>
            </div>
          );
        }
        
        return days;
      };

      return (
        <div className="min-h-screen bg-gray-100">
          <div className="sticky top-0 z-30 bg-white shadow-md">
            <div className="max-w-7xl mx-auto px-2">
              <div className="flex justify-between items-center py-2">
                <h1 className="text-lg font-bold text-blue-600">üì∑ Calendri-Booth</h1>
                
											
                <div className="flex gap-1 items-center text-xs">
                  {isSignedIn ? (
                    <>
                      <button
                        onClick={saveToDrive}
                        disabled={backupStatus === 'saving'}
                        className={`px-2 py-1 text-xs rounded ${
                          backupStatus === 'saving' ? 'bg-gray-300' :
                          backupStatus === 'success' ? 'bg-green-500 text-white' :
                          backupStatus === 'error' ? 'bg-red-500 text-white' :
                          'bg-blue-500 text-white hover:bg-blue-600'
                        }`}
                      >
                        {backupStatus === 'saving' ? 'üíæ...' :
                         backupStatus === 'success' ? '‚úÖ' :
                         backupStatus === 'error' ? '‚ùå' :
                         'üíæ'}
                      </button>
                      <button
                        onClick={handleGoogleSignOut}
                        className="px-2 py-1 text-xs bg-gray-500 text-white rounded"
                      >
                        ‚èèÔ∏è
                      </button>
                    </>
                  ) : (
                    <button
                      onClick={handleGoogleSignIn}
                      className="px-2 py-1 text-xs bg-blue-500 text-white rounded"
                    >
                      üîê Drive
                    </button>
                  )}
                </div>
              </div>

							  
															
																					   
					  
				

              <nav className="flex gap-1 border-b border-gray-200 pb-1 text-xs">
                <button
                  onClick={() => { setView('calendar'); setShowNotifications(false); }}
                  className={`px-2 py-1 rounded-t-lg ${
                    view === 'calendar' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                  }`}
                >
                  üìÖ
                </button>
                <button
                  onClick={() => { setView('admin'); setShowNotifications(false); }}
                  className={`px-2 py-1 rounded-t-lg ${
                    view === 'admin' ? 'bg-blue-500 text-white' : 'bg-gray-200'
                  }`}
                >
                  ‚öôÔ∏è
                </button>
                <button
                  onClick={() => setShowNotifications(!showNotifications)}
                  className="ml-auto px-2 py-1 rounded-t-lg bg-gray-200 relative"
                >
                  üîî
                  {unreadCount > 0 && (
                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold">
                      {unreadCount}
                    </span>
                  )}
                </button>
              </nav>
            </div>
          </div>

          <div className="max-w-7xl mx-auto p-2 text-sm">
            {showNotifications && (
              <div className="mb-4 bg-white rounded-lg shadow p-3">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-lg font-bold">üîî Notifications</h2>
                  <button onClick={() => setView('notif-settings')} className="text-blue-500 text-xs">‚öôÔ∏è</button>
                </div>
                {notifications.length === 0 ? (
                  <p className="text-gray-500 text-center py-4 text-sm">Aucune notification</p>
                ) : (
                  <div className="space-y-2">
                    {notifications.slice(0, 5).map(notif => (
                      <div key={notif.id} className={`p-2 rounded text-xs ${notif.read ? 'opacity-60' : ''}`}>
                        <div className="flex justify-between">
                          <span className="font-bold">{notif.title}</span>
                          <button onClick={() => deleteNotification(notif.id)} className="text-red-500">‚úï</button>
                        </div>
                        <p className="text-xs">{notif.message}</p>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {view === 'calendar' && (
              <>
                <div className="bg-white rounded-lg shadow p-3 mb-3">
                  <div className="flex justify-between items-center mb-2">
                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">‚Üê</button>
                    <h2 className="text-sm font-bold">{currentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}</h2>
                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">‚Üí</button>
                  </div>

                  <div className="grid grid-cols-7 gap-0.5 text-xs">
                    {['D', 'L', 'M', 'M', 'J', 'V', 'S'].map(day => (
                      <div key={day} className="text-center font-bold p-1 bg-gray-100 text-xs">{day}</div>
                    ))}
                    {renderCalendar()}
                  </div>
                </div>

                {themesAPreparer.length > 0 && (
                  <div className="bg-yellow-50 border border-yellow-300 rounded-lg p-3 mb-3">
                    <h2 className="text-sm font-bold mb-2">üé® Th√®mes √† pr√©parer</h2>
                    {themesAPreparer.map(res => (
                      <div key={res.id} className="bg-white p-2 rounded mb-2 text-xs">
                        <div className="font-bold">{res.clientNom}</div>
                        <div>{res.theme}</div>
                        <button onClick={() => toggleThemeRealise(res.id)} className="mt-1 px-2 py-1 bg-green-500 text-white rounded text-xs">‚úì Fait</button>
                      </div>
                    ))}
                  </div>
                )}

                <div className="flex gap-2">
                  <button onClick={() => openReservationModal()} className="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-sm">üì∑ Location</button>
                  <button onClick={() => openRdvModal()} className="flex-1 px-3 py-2 bg-green-500 text-white rounded text-sm">üìÖ RDV</button>
                </div>
              </>
            )}

            {view === 'admin' && (
              <div className="space-y-3">
                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">üì¶ Bornes</h3>
                    <button onClick={() => { setModalType('borne'); setFormData({ nom: '', modele: '' }); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+</button>
                  </div>
                  {bornes.map(b => (
                    <div key={b.id} className="border-b py-1 text-xs flex justify-between">
                      <span>{b.nom}</span>
                      <button onClick={() => setConfirmDelete({ type: 'borne', id: b.id })} className="text-red-500">üóëÔ∏è</button>
                    </div>
                  ))}
                </div>

                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">üí∞ Forfaits</h3>
                    <button onClick={() => { setModalType('forfait'); setFormData({ nom: '', prix: '', duree: '', nbPhotos: '' }); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+</button>
                  </div>
                  {forfaits.map(f => (
                    <div key={f.id} className="border-b py-1 text-xs flex justify-between">
                      <span>{f.nom} - {f.prix}‚Ç¨ {f.nbPhotos && `(${f.nbPhotos} photos)`}</span>
                      <button onClick={() => setConfirmDelete({ type: 'forfait', id: f.id })} className="text-red-500">üóëÔ∏è</button>
                    </div>
                  ))}
                </div>

                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">üéûÔ∏è Bobines</h3>
                    <button onClick={() => { setModalType('bobine'); const nextNum = bobines.length > 0 ? Math.max(...bobines.map(b => b.numero)) + 1 : 1; setFormData({ numero: nextNum, capacite: 400 }); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+</button>
                  </div>
                  {bobines.map(b => (
                    <div key={b.id} className="border-b py-1 text-xs">
                      <div className="flex justify-between">
                        <span>Bobine #{b.numero}</span>
                        <button onClick={() => setConfirmDelete({ type: 'bobine', id: b.id })} className="text-red-500">üóëÔ∏è</button>
                      </div>
                      <div className="text-xs text-gray-600">{b.photosRestantes} / {b.capacite} photos</div>
                    </div>
                  ))}
                </div>

                <div className="bg-white rounded-lg shadow p-3">
                  <div className="flex justify-between items-center mb-2">
                    <h3 className="font-bold text-sm">üì¶ Stock</h3>
                    <button onClick={() => { setModalType('stock'); setFormData({ nom: '', quantite: 0, seuilAlerte: 0, unite: 'pi√®ces' }); setShowAddModal(true); }} className="px-2 py-1 bg-blue-500 text-white rounded text-xs">+</button>
                  </div>
                  {stock.map(s => (
                    <div key={s.id} className="border-b py-1 text-xs flex justify-between">
                      <span>{s.nom}: {s.quantite} {s.unite}</span>
                      <button onClick={() => setConfirmDelete({ type: 'stock', id: s.id })} className="text-red-500">üóëÔ∏è</button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {view === 'notif-settings' && (
              <div className="bg-white rounded-lg shadow p-3">
                <h2 className="text-lg font-bold mb-3">‚öôÔ∏è Param√®tres Telegram</h2>
                <div className="space-y-2">
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" checked={notificationSettings.telegram.enabled} onChange={(e) => setNotificationSettings(prev => ({ ...prev, telegram: { ...prev.telegram, enabled: e.target.checked } }))} />
                    <span>Activer Telegram</span>
                  </label>
                  <input type="text" placeholder="Bot Token" value={notificationSettings.telegram.botToken} onChange={(e) => setNotificationSettings(prev => ({ ...prev, telegram: { ...prev.telegram, botToken: e.target.value } }))} className="w-full p-2 border rounded text-sm" />
                  <input type="text" placeholder="Chat ID" value={notificationSettings.telegram.chatId} onChange={(e) => setNotificationSettings(prev => ({ ...prev, telegram: { ...prev.telegram, chatId: e.target.value } }))} className="w-full p-2 border rounded text-sm" />
                  <button onClick={() => sendTelegramNotification('Test', '‚úÖ √áa marche !')} className="w-full px-3 py-2 bg-green-500 text-white rounded text-sm">üì§ Test</button>
                  <button onClick={() => setView('calendar')} className="w-full px-3 py-2 bg-blue-500 text-white rounded text-sm">Retour</button>
                </div>
              </div>
            )}
          </div>

          {showDateMenu && (
            <>
              <div className="fixed inset-0 z-40" onClick={() => setShowDateMenu(null)}></div>
              <div className="fixed z-50 bg-white rounded-lg shadow-xl border p-2 text-sm" style={{ left: showDateMenu.x, top: showDateMenu.y }}>
                <button onClick={() => openReservationModal(showDateMenu.date)} className="block w-full text-left px-3 py-2 hover:bg-blue-100 rounded whitespace-nowrap text-sm">üì∑ Nouvelle location</button>
                <button onClick={() => openRdvModal(showDateMenu.date)} className="block w-full text-left px-3 py-2 hover:bg-green-100 rounded whitespace-nowrap text-sm">üìÖ Nouveau RDV</button>
              </div>
            </>
          )}

          {showEventDetail && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[80vh] overflow-y-auto text-sm">
                <div className="flex justify-between mb-3">
                  <h3 className="font-bold text-sm">{showEventDetail.type === 'reservation' ? 'üì∑ Location' : 'üìÖ RDV'}</h3>
                  <button onClick={() => setShowEventDetail(null)} className="text-xl">‚úï</button>
                </div>
                <div className="space-y-2 text-xs">
                  <div><strong>Client:</strong> {showEventDetail.clientNom}</div>
                  <div><strong>T√©l:</strong> {showEventDetail.clientTel}</div>
                  {showEventDetail.type === 'reservation' && (
                    <>
                      <div><strong>Date:</strong> {showEventDetail.dateDebut} √† {showEventDetail.heureDebut}</div>
                      {showEventDetail.theme && <div><strong>Th√®me:</strong> {showEventDetail.theme}</div>}
                    </>
                  )}
                </div>
                <div className="flex gap-2 mt-3">
                  <button onClick={() => { setEditingItem(showEventDetail); setFormData(showEventDetail); setModalType(showEventDetail.type); setShowEventDetail(null); setShowAddModal(true); }} className="flex-1 px-3 py-2 bg-blue-500 text-white rounded text-xs">‚úèÔ∏è Modifier</button>
                  <button onClick={() => { setConfirmDelete({ type: showEventDetail.type, id: showEventDetail.id }); setShowEventDetail(null); }} className="flex-1 px-3 py-2 bg-red-500 text-white rounded text-xs">üóëÔ∏è Supprimer</button>
                </div>
              </div>
            </div>
          )}

          {showAddModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-md w-full max-h-[80vh] overflow-y-auto text-sm">
                <h3 className="font-bold mb-3 text-sm">{editingItem ? 'Modifier' : 'Ajouter'}</h3>
                
                {modalType === 'borne' && (
                  <div className="space-y-2">
                    <input type="text" placeholder="Nom" value={formData.nom || ''} onChange={(e) => setFormData({ ...formData, nom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Mod√®le" value={formData.modele || ''} onChange={(e) => setFormData({ ...formData, modele: e.target.value })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'forfait' && (
                  <div className="space-y-2">
                    <input type="text" placeholder="Nom" value={formData.nom || ''} onChange={(e) => setFormData({ ...formData, nom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Prix (‚Ç¨)" value={formData.prix || ''} onChange={(e) => setFormData({ ...formData, prix: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Dur√©e" value={formData.duree || ''} onChange={(e) => setFormData({ ...formData, duree: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Nb photos" value={formData.nbPhotos || ''} onChange={(e) => setFormData({ ...formData, nbPhotos: parseInt(e.target.value) || '' })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'bobine' && (
                  <div className="space-y-2">
                    <input type="number" placeholder="Num√©ro" value={formData.numero || ''} onChange={(e) => setFormData({ ...formData, numero: parseInt(e.target.value) || '' })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Capacit√©" value={formData.capacite || ''} onChange={(e) => setFormData({ ...formData, capacite: parseInt(e.target.value) || 400 })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'stock' && (
                  <div className="space-y-2">
                    <input type="text" placeholder="Nom" value={formData.nom || ''} onChange={(e) => setFormData({ ...formData, nom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Quantit√©" value={formData.quantite || ''} onChange={(e) => setFormData({ ...formData, quantite: parseInt(e.target.value) || 0 })} className="w-full p-2 border rounded text-sm" />
                    <input type="number" placeholder="Seuil" value={formData.seuilAlerte || ''} onChange={(e) => setFormData({ ...formData, seuilAlerte: parseInt(e.target.value) || 0 })} className="w-full p-2 border rounded text-sm" />
                  </div>
                )}

                {modalType === 'reservation' && (
                  <div className="space-y-2">
                    <select value={formData.borneId || ''} onChange={(e) => setFormData({ ...formData, borneId: e.target.value })} className="w-full p-2 border rounded text-sm">
                      <option value="">Borne</option>
                      {bornes.map(b => <option key={b.id} value={b.id}>{b.nom}</option>)}
                    </select>
                    <select value={formData.forfaitId || ''} onChange={(e) => setFormData({ ...formData, forfaitId: e.target.value })} className="w-full p-2 border rounded text-sm">
                      <option value="">Forfait</option>
                      {forfaits.map(f => <option key={f.id} value={f.id}>{f.nom}</option>)}
                    </select>
                    <input type="text" placeholder="Client" value={formData.clientNom || ''} onChange={(e) => setFormData({ ...formData, clientNom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="tel" placeholder="T√©l√©phone" value={formData.clientTel || ''} onChange={(e) => setFormData({ ...formData, clientTel: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="date" value={formData.dateDebut || ''} onChange={(e) => setFormData({ ...formData, dateDebut: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="time" value={formData.heureDebut || ''} onChange={(e) => setFormData({ ...formData, heureDebut: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <textarea placeholder="Th√®me" value={formData.theme || ''} onChange={(e) => setFormData({ ...formData, theme: e.target.value })} className="w-full p-2 border rounded text-sm h-16"></textarea>
                  </div>
                )}

                {modalType === 'rdv' && (
                  <div className="space-y-2">
                    <input type="date" value={formData.date || ''} onChange={(e) => setFormData({ ...formData, date: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="time" value={formData.heure || ''} onChange={(e) => setFormData({ ...formData, heure: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="text" placeholder="Client" value={formData.clientNom || ''} onChange={(e) => setFormData({ ...formData, clientNom: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <input type="tel" placeholder="T√©l√©phone" value={formData.clientTel || ''} onChange={(e) => setFormData({ ...formData, clientTel: e.target.value })} className="w-full p-2 border rounded text-sm" />
                    <textarea placeholder="Description" value={formData.description || ''} onChange={(e) => setFormData({ ...formData, description: e.target.value })} className="w-full p-2 border rounded text-sm h-16"></textarea>
                  </div>
                )}

                <div className="flex gap-2 mt-3">
                  <button onClick={handleSave} className="flex-1 px-3 py-2 bg-green-500 text-white rounded text-sm">‚úì OK</button>
                  <button onClick={() => setShowAddModal(false)} className="flex-1 px-3 py-2 bg-gray-500 text-white rounded text-sm">‚úï Annuler</button>
                </div>
              </div>
            </div>
          )}

          {confirmDelete && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-3">
              <div className="bg-white rounded-lg p-4 max-w-sm w-full text-sm">
                <h3 className="font-bold mb-3">Supprimer ?</h3>
                <div className="flex gap-2">
                  <button onClick={() => handleDelete(confirmDelete.type, confirmDelete.id)} className="flex-1 px-3 py-2 bg-red-500 text-white rounded text-sm">Supprimer</button>
                  <button onClick={() => setConfirmDelete(null)} className="flex-1 px-3 py-2 bg-gray-500 text-white rounded text-sm">Annuler</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

									
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Calendrier-APP/service-worker.js')
          .then(reg => console.log('SW OK'))
          .catch(err => console.error('SW erreur:', err));
      });
    }

								
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
														
      const installBtn = document.createElement('button');
      installBtn.textContent = 'üì± Installer';
      installBtn.className = 'fixed bottom-4 right-4 px-4 py-2 bg-blue-500 text-white rounded-lg shadow-lg z-50 text-sm';
      installBtn.onclick = async () => {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.remove();
        }
        deferredPrompt = null;
      };
      document.body.appendChild(installBtn);
    });

    ReactDOM.render(<PhotoboothManager />, document.getElementById('root'));
  </script>
</body>
</html>
